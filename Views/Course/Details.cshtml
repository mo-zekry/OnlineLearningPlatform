@model CourseViewModel

@{
    ViewData["Title"] = "Course Details";
    var modules = ViewData["Modules"] as List<Module>;
    var quizzes = ViewData["Quizzes"] as List<Quiz>;
    var userRole = User.IsInRole("Admin") ? "Admin" : User.IsInRole("Student") ? "Student" : "Guest";
}

<div class="container mt-5">
    <!-- Course Header -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h1 class="display-4">@Model.Name</h1>
            <p class="lead text-muted">@Model.Description</p>
            <h4 class="text-success">Price: @Model.Price.ToString("C")</h4>
            <ul class="list-group">
                <li class="list-group-item"><strong>Number of Modules:</strong> @(modules?.Count ?? 0)</li>
                <li class="list-group-item"><strong>Number of Lessons:</strong> @(modules?.Sum(m => m.Lessons?.Count) ?? 0)</li>
                <li class="list-group-item"><strong>Number of Quizzes:</strong> @(quizzes?.Count ?? 0)</li>
            </ul>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <img
                    src="@Model.ImageUrl"
                    alt="@Model.Name"
                    class="card-img-top"
                />
            </div>
        </div>
    </div>

    <!-- Modules Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-3">Modules</h2>
                <!-- Toggle buttons for modules -->
                <div>
                    <button
                        id="expandAllModules"
                        class="btn btn-primary btn-sm"
                        onclick="toggleAllModules(true)"
                    >
                        Expand All
                    </button>
                    <button
                        id="collapseAllModules"
                        class="btn btn-outline-secondary btn-sm"
                        onclick="toggleAllModules(false)"
                    >
                        Collapse All
                    </button>
                </div>
            </div>
            @if (modules != null && modules.Any())
            {
                <div
                    class="accordion "
                    id="accordionModules"
                >
                    @foreach (var module in modules)
                    {
                        <div class="accordion-item mb-3">
                            <h2
                                class="accordion-header"
                                id="heading@(module.Id)"
                            >
                                <button
                                    class="accordion-button collapsed"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapse@(module.Id)"
                                    aria-expanded="false"
                                    aria-controls="collapse@(module.Id)"
                                >
                                    <strong>@module.Name</strong> <span class="badge bg-primary ms-2">@module.Lessons.Count
                                        Lessons</span>
                                </button>
                            </h2>
                            <div
                                id="collapse@(module.Id)"
                                class="accordion-collapse collapse"
                                aria-labelledby="heading@(module.Id)"
                                data-bs-parent="#accordionModules"
                            >
                                <div class="accordion-body">
                                    @foreach (var lesson in module.Lessons)
                                    {
                                        <div class="mb-4 card shadow-sm p-3">
                                            <h5 class="fw-bold">@lesson.Name</h5>
                                            <p class="text-muted">@lesson.LessonDetails</p>
                                            <div class="ratio ratio-16x9 mb-3">
                                                <iframe
                                                    src="@lesson.VideoUrl.Replace("watch?v=", "embed/")"
                                                    allowfullscreen
                                                >
                                                </iframe>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">No modules available at the moment.</div>
            }
        </div>
    </div>

    <!-- Quizzes Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-3">Quizzes</h2>
                <!-- Toggle buttons for quizzes -->
                <div>
                    <button
                        id="expandAllQuizzes"
                        class="btn btn-outline-primary btn-sm"
                        onclick="toggleAllQuizzes(true)"
                    >
                        Expand All
                    </button>
                    <button
                        id="collapseAllQuizzes"
                        class="btn btn-outline-secondary btn-sm"
                        onclick="toggleAllQuizzes(false)"
                    >
                        Collapse All
                    </button>
                </div>
            </div>
            @if (quizzes != null && quizzes.Any())
            {
                <div class="list-group">
                    @foreach (var quiz in quizzes)
                    {
                        <a
                            asp-action="Details"
                            asp-route-id="@quiz.Id"
                            asp-controller="Quiz"
                            class="list-group-item list-group-item-action"
                        >
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">@quiz.Name</h5>
                                <small class="text-muted">Questions: @quiz.QuizQuestions.Count</small>
                            </div>
                            <p class="mb-1">
                                <strong>Minimum Passing Score:</strong> @quiz.MinPassScore
                            </p>
                            <p class="mb-1">
                                <strong>Pass Required:</strong> @(quiz.IsPassRequired ? "Yes" : "No")
                            </p>
                        </a>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">No quizzes available at the moment.</div>
            }
        </div>
    </div>
</div>

<script>
    // Function to toggle all module sections
    function toggleAllModules(expand) {
        var accordionItems = document.querySelectorAll('#accordionModules .accordion-collapse');
        accordionItems.forEach(function (item) {
            if (expand) {
                item.classList.add('show');
                item.previousElementSibling.querySelector('.accordion-button').classList.remove('collapsed');
                item.previousElementSibling.querySelector('.accordion-button').setAttribute('aria-expanded', 'true');
            } else {
                item.classList.remove('show');
                item.previousElementSibling.querySelector('.accordion-button').classList.add('collapsed');
                item.previousElementSibling.querySelector('.accordion-button').setAttribute('aria-expanded', 'false');
            }
        });
    }

    // Function to toggle all quiz sections
    function toggleAllQuizzes(expand) {
        var quizLinks = document.querySelectorAll('.list-group-item');
        quizLinks.forEach(function (link) {
            if (expand) {
                link.classList.remove('collapsed');
                link.setAttribute('aria-expanded', 'true');
            } else {
                link.classList.add('collapsed');
                link.setAttribute('aria-expanded', 'false');
            }
        });
    }

    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>
